# BC26 AT 指令功耗控制

- [工作模式](#%E5%B7%A5%E4%BD%9C%E6%A8%A1%E5%BC%8F)
- [eDRX 設定](#edrx-%E8%A8%AD%E5%AE%9A)
	- [一般指令](#%E4%B8%80%E8%88%AC%E6%8C%87%E4%BB%A4)
	- [Quectel 專有](#quectel-%E5%B0%88%E6%9C%89)
- [PSM 設定](#psm-%E8%A8%AD%E5%AE%9A)
	- [設定 PSM](#%E8%A8%AD%E5%AE%9A-psm)
	- [查看 PSM 設定](#%E6%9F%A5%E7%9C%8B-psm-%E8%A8%AD%E5%AE%9A)
	- [回報 PSM 狀態](#%E5%9B%9E%E5%A0%B1-psm-%E7%8B%80%E6%85%8B)
	- [PSM 設定範例](#psm-%E8%A8%AD%E5%AE%9A%E7%AF%84%E4%BE%8B)
- [其他功耗控制](#%E5%85%B6%E4%BB%96%E5%8A%9F%E8%80%97%E6%8E%A7%E5%88%B6)
	- [功能層級](#%E5%8A%9F%E8%83%BD%E5%B1%A4%E7%B4%9A)
	- [網路釋放](#%E7%B6%B2%E8%B7%AF%E9%87%8B%E6%94%BE)
	- [解除睡眠鎖](#%E8%A7%A3%E9%99%A4%E7%9D%A1%E7%9C%A0%E9%8E%96)
	- [設定睡眠模式](#%E8%A8%AD%E5%AE%9A%E7%9D%A1%E7%9C%A0%E6%A8%A1%E5%BC%8F)
- [二進制對應表](#%E4%BA%8C%E9%80%B2%E5%88%B6%E5%B0%8D%E6%87%89%E8%A1%A8)
	- [eDRX 週期時間長度](#edrx-%E9%80%B1%E6%9C%9F%E6%99%82%E9%96%93%E9%95%B7%E5%BA%A6)
	- [PTW 尋呼時間窗口長度](#ptw-%E5%B0%8B%E5%91%BC%E6%99%82%E9%96%93%E7%AA%97%E5%8F%A3%E9%95%B7%E5%BA%A6)
	- [T3324 活動時間計時器](#t3324-%E6%B4%BB%E5%8B%95%E6%99%82%E9%96%93%E8%A8%88%E6%99%82%E5%99%A8)
	- [T3412 週期性追蹤區更新計時器](#t3412-%E9%80%B1%E6%9C%9F%E6%80%A7%E8%BF%BD%E8%B9%A4%E5%8D%80%E6%9B%B4%E6%96%B0%E8%A8%88%E6%99%82%E5%99%A8)


## 工作模式

- `AT+CSCON?`: 查詢連接狀態所在工作模式
  - 返回值: `+CSCON: <n>,<mode>`
    - `<n>`
      - `0`: 禁用 URC 通知輸出
      - `1`: 啟用 URC `+CSCON: <mode>` 通知輸出
    - `<mode>`
      - `0`: IDLE 狀態
      - `1`: Connented 狀態

範例
```py
# 進行 PING 通訊，進入 Connented 狀態
20:43:25.019 -> AT+QPING=1,"8.8.8.8"
20:43:25.019 -> OK
20:43:25.440 -> +QPING: 0,"8.8.8.8",32,370,55
20:43:26.539 -> +QPING: 0,"8.8.8.8",32,130,55
20:43:27.853 -> +QPING: 0,"8.8.8.8",32,260,55
20:43:29.122 -> +QPING: 0,"8.8.8.8",32,260,55
20:43:29.122 -> +QPING: 0,4,4,0,130,370,255

# 結束後立刻查詢工作模式
# 在 Connented 狀態
20:43:32.195 -> AT+CSCON?
20:43:32.195 -> +CSCON: 0,1

# 等待數秒後系統確認無資料傳輸
# 進入 IDLE 狀態
20:43:36.568 -> AT+CSCON?
20:43:36.568 -> +CSCON: 0,0
```

## eDRX 設定

### 一般指令

- `AT+CEDRXS=<mode>,[AcT_type],[requested_eDRX_value]`: 設定 eDRX 週期
  - `<mode>`: 整數類型，表示是否啟用 eDRX
    - `0`: 停用 eDRX
    - `1`: 啟用 eDRX
    - `2`: 啟用 eDRX 並啟用 URC `+CEDRXP` 回報 eDRX 狀態
    - `3`: 重置為預設值
  - `[AcT_type]`: 整數類型，訪問技術類型
    - `0`: 不使用 eDRX 的訪問技術
    - `5`: E-UTRAN (NB-S1 模式)
  - `<requested_eDRX_value>`: 請求的 eDRX 週期長度，參考 [eDRX 週期時間長度](#eDRX%20週期時間長度)
  - 返回值: `+CEDRXP: <AcT_type>,<requested_eDRX_value>,<NW_provided_eDRX_value>,<paging_time_window>`
    - `<AcT_type>`: 訪問技術類型，表示目前所使用的技術
      - `0`: 訪問技術未使用 eDRX
      - `5`: E-UTRAN (NB-S1 模式)
    - `<requested_eDRX_value>`: UE 所請求的 eDRX 週期長度，參考 [eDRX 週期時間長度](#eDRX%20週期時間長度)
    - `<NW_provided_eDRX_value>`: 網路提供的 eDRX 週期長度，參考 [eDRX 週期時間長度](#eDRX%20週期時間長度)
    - `<paging_time_window>`: 網路提供的 PTW 尋呼時間窗口長度，參考 [PTW 尋呼時間窗口長度](#PTW%20尋呼時間窗口長度)

- `AT+CEDRXRDP`: 查看 eDRX 相關設定
  - 返回值: `+CEDRXRDP: <AcT_type>,<requested_eDRX_value>,<NW_provided_eDRX_value>,<paging_time_window>`
    - `<AcT_type>`: 訪問技術類型，表示目前所使用的技術
      - `0`: 訪問技術未使用 eDRX
      - `5`: E-UTRAN (NB-S1 模式)
    - `<requested_eDRX_value>`: UE 所請求的 eDRX 週期長度，參考 [eDRX 週期時間長度](#eDRX%20週期時間長度)
    - `<NW_provided_eDRX_value>`: 網路提供的 eDRX 週期長度，參考 [eDRX 週期時間長度](#eDRX%20週期時間長度)
    - `<paging_time_window>`: 網路提供的 PTW 尋呼時間窗口長度，參考 [PTW 尋呼時間窗口長度](#PTW%20尋呼時間窗口長度)

> `<requested_eDRX_value>` 和 `<NW_provided_eDRX_value>` 不一致時，可能會導致 eDRX 週期無法正確設定

設定範例

```py
# 設定 eDRX 週期為 40.96s
# 2 啟用回報，5 啟用 eDRX，"0011" 代表 40.96s
20:28:32.232 -> AT+CEDRXS=2,5,"0011"
20:28:32.232 -> OK
20:28:32.808 -> 
20:28:32.808 -> +CEDRXP: 5,"0011","0011","0011"

# 讀取設定資訊
20:31:07.608 -> AT+CEDRXS?
20:31:07.608 -> +CEDRXS: 5,"0011"

# 讀取設定和網路提供的 eDRX 週期是否一致
20:31:24.957 -> AT+CEDRXRDP
20:31:24.957 -> +CEDRXRDP: 5,"0011","0011","0011"
20:31:24.957 -> 
20:31:24.957 -> OK
```

### Quectel 專有

- `AT+QEDRXCFG`: Quectel 專有指令，設定 eDRX 相關設定
  - `AT+QEDRXCFG=<mode>,[AcT_type],[requested_eDRX_value],[requested_paging_time_window_value]`: 設定 eDRX 週期
    - `<mode>`: 整數類型，表示是否啟用 eDRX
      - `0`: 停用 eDRX
      - `1`: 啟用 eDRX
      - `2`: 啟用 eDRX 並啟用 URC `+CEDRXP` 回報 eDRX 狀態
      - `3`: 重置為預設值
    - `[AcT_type]`: 整數類型，訪問技術類型
      - `0`: 不使用 eDRX 的訪問技術
      - `5`: E-UTRAN (NB-S1 模式)
    - `<requested_eDRX_value>`: 請求的 eDRX 週期長度，參考 [eDRX 週期時間長度](#eDRX%20週期時間長度)
    - `<requested_paging_time_window_value>`: 請求的 PTW 尋呼時間窗口長度，參考 [PTW 尋呼時間窗口長度](#PTW%20尋呼時間窗口長度)
  - `AT+QEDRXCFG?`: 查看 eDRX 相關設定
    - 返回值: `+QEDRXCFG: <AcT_type>,<requested_eDRX_value>,<requested_paging_time_window_value>`
      - `<AcT_type>`: 訪問技術類型，表示目前所使用的技術
        - `0`: 訪問技術未使用 eDRX
        - `5`: E-UTRAN (NB-S1 模式)
      - `<requested_eDRX_value>`: UE 所請求的 eDRX 週期長度，參考 [eDRX 週期時間長度](#eDRX%20週期時間長度)
      - `<requested_paging_time_window_value>`: UE 所請求的 PTW 尋呼時間窗口長度，參考 [PTW 尋呼時間窗口長度](#PTW%20尋呼時間窗口長度)

> `AT+QEDRXCFG?` 僅能查看指令設定值，當與網路提供的 eDRX 週期不一致時，查看到的值可能不正確

設定範例
```py
# 設定 eDRX 週期為 163.84s，PTW 尋呼時間窗口為 10.24s
20:38:15.306 -> AT+QEDRXCFG=2,5,"1001","0011"
20:38:15.352 -> OK
20:38:15.744 -> 
20:38:15.744 -> +CEDRXP: 5,"1001","1001","0011"

# 恢復設定為預設值
20:38:55.475 -> AT+QEDRXCFG=3
20:38:55.511 -> OK

# 讀取設定資訊
20:39:10.766 -> AT+QEDRXCFG?
20:39:10.807 -> +QEDRXCFG: 5,"0101","0011"
```

## PSM 設定

### 設定 PSM

- `AT+CPSMS=<mode>,,,[requested_periodic_TAU],[requested_active_time]`: 設定 PSM 狀態和 T3324,T3412 計時器
  - `<mode>`: 整數類型，表示是否啟用 PSM
    - `0`: 停用 PSM
    - `1`: 啟用 PSM
    - `2`: 重置為預設值
  - `[requested_periodic_TAU]`: 請求的 T3412 週期，參考 [T3412 週期性追蹤區更新計時器](#T3412%20週期性追蹤區更新計時器)
  - `[requested_active_time]`: 請求的 T3324 活動時間計時器，參考 [T3324 活動時間計時器](#T3324%20活動時間計時器)

### 查看 PSM 設定

- `AT+CPSMS?`: 查看 PSM 設定
  - 返回值: `+CPSMS: <mode>,,,[requested_periodic_TAU],[requested_active_time]`
    - `[requested_periodic_TAU]`: 請求的 T3412 週期，參考 [T3412 週期性追蹤區更新計時器](#T3412%20週期性追蹤區更新計時器)
    - `[requested_active_time]`: 請求的 T3324 活動時間計時器，參考 [T3324 活動時間計時器](#T3324%20活動時間計時器)
    
> `AT+CPSMS?` 僅能查看指令設定值，當與網路提供的 PSM 設定不一致時，查看到的值可能不正確

- `AT+CEREG?`: 查看當前網路的 T3324 和 T3412 計時器
  - 返回值: `+CEREG: ...., <Active-Time>, <Periodic-TAU>`
    - `<Active-Time>`: 當前的 T3324 活動時間計時器，參考 [T3324 活動時間計時器](#T3324%20活動時間計時器)
    - `<Periodic-TAU>`: 當前的 T3412 週期性追蹤區更新計時器，參考 [T3412 週期性追蹤區更新計時器](#T3412%20週期性追蹤區更新計時器)

> 使用 `AT+CEREG?` 查看到的為當前網路提供計時器數值，為**正確數值**，如果與設定值不一致，則會使用網路提供的值

### 回報 PSM 狀態

- `AT+QNBIOTEVENT=<enable>,<event>`: 啟用 / 禁用 回報 PSM 事件
  - `<enable>`: 
    - `0`: 禁用
    - `1`: 啟用
  - `<event>`
    - `1`: PSM 狀態
  - 回報值: `+QNBIOTEVENT: <event_value>`
    - `<event_value>`
      - `ENTER PSM`
      - `EXIT PSM`

> 當 PSM 進入或退出時，會回報 `+QNBIOTEVENT: <event_value>`

- `AT+CEREG=<n>`: 設定回報事件等級
  - `<n>`: 整數類型，代表回報事件等級
    - `0`: 完全不回報網路註冊狀態
    - `1`: 只回報註冊狀態 (已註冊或未註冊)
    - `2`: 回報註冊狀態和網路位置資訊 (例如小區 ID 和追蹤區域碼)
    - `3`: 除了註冊狀態和位置資訊外，還回報網路註冊失敗的原因
    - `4` 和 `5`: 當設備進入低功耗模式 (PSM) 時，回報更多與節電相關的資訊

> `AT+CEREG=4` 和 `AT+CEREG=5` 會回報 PSM 進入和退出事件

### PSM 設定範例

```py
# 設定回報 PSM 修改後的網路註冊狀態事件
21:47:33.306 -> AT+CEREG=5
21:47:33.306 -> OK

# 設定回報 進入/退出 PSM 事件
21:47:56.353 -> AT+QNBIOTEVENT=1,1
21:47:56.353 -> OK

# 設定 PSM 週期
# T3324 -> 00100100
# T3412 -> 00100011
21:51:04.987 -> AT+CPSMS=1,,,"00100011","00100100" 
21:51:04.987 -> OK

# AT+CEREG 回報的 PSM 調整後觸發的事件                T3324      T3412
21:51:05.030 -> +CEREG: 2,"CE40","0C6EDE83",9,0,0,"00100011","00010101"
21:51:06.196 -> +CEREG: 1,"CE40","0C6EDE83",9,0,0,"00100100","00010100"
# T3324 修改成功為 4m，T3412 **修改失敗**使用網路提供 200m

# 等待 4m 後，觸發 PSM 進入事件
21:55:06.291 -> +QNBIOTEVENT: "ENTER PSM"
```

## 其他功耗控制

### 功能層級

- `AT+CFUN=<fun>,[rst]`: 設定 UE 功能層級
  - `<fun>`: 整數類型，表示 UE 的功能層級
    - `0`: 最低功能 (Minimum functionality)
    - `1`: 完全功能 (Full functionality)
    - `4`: 停止 RF 無線訊號傳送與接收
    - `7`: 僅停用 USIM，RF 無線訊號傳送與接收仍然活躍
  - `<rst>`: 整數類型，重置選項
    - `0`: 指令立即生效，並在深睡眠喚醒後仍有效，但不會儲存至 NVRAM
    - `1`: 指令在重置後生效，並在深睡眠喚醒後有效，配置會自動儲存至 NVRAM
    - `2`: 指令立即生效，並在深睡眠喚醒後有效，配置會自動儲存至 NVRAM​

### 網路釋放

- `AT+QNBIOTRAI=<rai_mode>`: 設定 NB-IoT 釋放輔助指示，用於優化設備在上行傳輸後的網路資源管理
  - `<rai_mode>`: 整數類型，指定傳輸後的連接釋放策略
    - `0`: 無輔助釋放資訊或不適用
    - `1`: 僅發送一個上行封包，不期待下行回應。適用於單向傳輸場景（如設備上報數據無需回應），可快速釋放連接。
    - `2`: 僅發送一個上行封包，並期待一次下行回應。適用於簡單的查詢場景（如設備上報狀態後等待一次確認），完成後釋放連接。

> 幫助設備在完成簡單通訊需求後，根據設定的模式快速釋放網路連接資源，從而達到節省電量及減少網路負荷的目的。

### 解除睡眠鎖

- `AT+QRELLOCK`: 解除模組的「防止睡眠」狀態

> 通常模組在執行完一個 AT 指令後，會有 10 秒的保護期，這段時間模組不會進入睡眠模式，確保指令執行不受影響。但如果我們想讓模組馬上可以進入睡眠，可以用這個指令來解除這個保護期。

### 設定睡眠模式

- `AT+QSCLK=<n>`: 設定模組的睡眠模式
  - `<n>`: 整數類型，用於控制模組的睡眠模式
    - `0`: 停用睡眠模式，UART 持續工作
    - `1`: 啟用淺和深睡眠模式
    - `2`: 啟用僅淺睡眠模式，可透過 UART 喚醒

> - 當設定為 `AT+QSCLK=1` 或 `AT+QSCLK=2` 時，UART 將在淺睡眠模式下停用，需要先發送 AT 指令喚醒 UART
> - 在資料傳輸期間，建議使用 `AT+QSCLK=0` 停用睡眠模式；傳輸結束後，建議重新啟用睡眠模式（`AT+QSCLK=1`）以節省電力

## 二進制對應表

### eDRX 週期時間長度

|   4   |   3   |   2   |   1   | 時間長度          |
| :---: | :---: | :---: | :---: | ----------------- |
|   0   |   0   |   1   |   0   | 20.48s            |
|   0   |   0   |   1   |   1   | 40.96s            |
|   0   |   1   |   0   |   1   | 81.92s (1.36m)    |
|   1   |   0   |   0   |   1   | 163.84s (2.73m)   |
|   1   |   0   |   1   |   0   | 327.68s (5.46m)   |
|   1   |   0   |   1   |   1   | 655.36s (10.92m)  |
|   1   |   1   |   0   |   0   | 1310.72s (21.85m) |
|   1   |   1   |   0   |   1   | 2621.44s (43.69m) |
|   1   |   1   |   1   |   0   | 5242.88s (1.46h)  |
|   1   |   1   |   1   |   1   | 10485.76s (2.92h) |

### PTW 尋呼時間窗口長度

|   4   |   3   |   2   |   1   | 時間長度 |
| :---: | :---: | :---: | :---: | :------: |
|   0   |   0   |   0   |   0   |  2.56s   |
|   0   |   0   |   0   |   1   |  5.12s   |
|   0   |   0   |   1   |   0   |  7.68s   |
|   0   |   0   |   1   |   1   |  10.24s  |
|   0   |   1   |   0   |   0   |  12.8s   |
|   0   |   1   |   0   |   1   |  15.36s  |
|   0   |   1   |   1   |   0   |  17.92s  |
|   0   |   1   |   1   |   1   |  20.48s  |
|   1   |   0   |   0   |   0   |  23.04s  |
|   1   |   0   |   0   |   1   |  25.6s   |
|   1   |   0   |   1   |   0   |  28.16s  |
|   1   |   0   |   1   |   1   |  30.72s  |
|   1   |   1   |   0   |   0   |  33.28s  |
|   1   |   1   |   0   |   1   |  35.84s  |
|   1   |   1   |   1   |   0   |  38.4s   |
|   1   |   1   |   1   |   1   |  40.96s  |

### T3324 活動時間計時器

|   8   |   7   |   6   | 時間       |
| :---: | :---: | :---: | ---------- |
|   0   |   0   |   0   | 2s         |
|   0   |   0   |   1   | 1m         |
|   0   |   1   |   0   | 6m         |
|   1   |   1   |   1   | 計時器停用 |

計算方式

```
T3324 == 00100010

876 54321 位
001 00010 值
1m X 2 = 2m
```

### T3412 週期性追蹤區更新計時器

|   8   |   7   |   6   | 時間       |
| :---: | :---: | :---: | ---------- |
|   0   |   0   |   0   | 10m        |
|   0   |   0   |   1   | 1h         |
|   0   |   1   |   0   | 10h        |
|   0   |   1   |   1   | 2s         |
|   1   |   0   |   0   | 30s        |
|   1   |   0   |   1   | 1m         |
|   1   |   1   |   0   | 320h       |
|   1   |   1   |   1   | 計時器停用 |

計算方式

```
T3412 == 00010101

876 54321 位
000 10101 值
10m X 21 = 210m
```